# Maintainer: VitaPlex
# Modified from switchfin's curl build with threaded resolver enabled

pkgname=curl
pkgver=8.11.0
pkgrel=1
pkgdesc="curl with threaded resolver for better HTTP on Vita"
url="https://curl.se/"
depends=('mbedtls' 'zlib')
source=("https://curl.se/download/curl-${pkgver}.tar.xz")
sha256sums=('SKIP')

build() {
    cd curl-${pkgver}

    cmake -B build -DCMAKE_TOOLCHAIN_FILE=$VITASDK/share/vita.toolchain.cmake \
        -DCMAKE_INSTALL_PREFIX=$prefix \
        -DCMAKE_BUILD_TYPE=Release \
        -DBUILD_CURL_EXE=OFF \
        -DBUILD_SHARED_LIBS=OFF \
        -DBUILD_TESTING=OFF \
        -DBUILD_EXAMPLES=OFF \
        -DBUILD_LIBCURL_DOCS=OFF \
        -DBUILD_MISC_DOCS=OFF \
        -DENABLE_CURL_MANUAL=OFF \
        -DHTTP_ONLY=ON \
        -DCURL_USE_MBEDTLS=ON \
        -DCURL_DISABLE_PROGRESS_METER=ON \
        -DENABLE_IPV6=OFF \
        -DENABLE_THREADED_RESOLVER=ON \
        -DUSE_NGHTTP2=OFF \
        -DUSE_LIBIDN2=OFF \
        -DCURL_BROTLI=OFF \
        -DCURL_ZSTD=OFF \
        -DCURL_USE_LIBSSH2=OFF \
        -DCURL_USE_LIBPSL=OFF

    # Remove HAVE_PIPE2 if it causes issues
    sed 's/#define HAVE_PIPE2 1//g' -i build/lib/curl_config.h 2>/dev/null || true

    cmake --build build -j$(nproc)
}

package() {
    cd curl-${pkgver}
    DESTDIR=$pkgdir cmake --install build
}
