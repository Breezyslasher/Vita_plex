# Maintainer: VitaPlex
# Modified from switchfin's ffmpeg build to enable HTTP streaming

pkgname=ffmpeg
pkgver=n6.0
pkgrel=4
pkgdesc="FFmpeg with HTTP streaming fixes for Vita"
url="https://ffmpeg.org/"
depends=('mbedtls' 'libass')
source=(
    "https://github.com/FFmpeg/FFmpeg/archive/${pkgver}.tar.gz"
    "ffmpeg.patch"
)
sha256sums=('SKIP' 'SKIP')

prepare() {
    cd FFmpeg-${pkgver}
    patch --strip=1 --input=${srcdir}/ffmpeg.patch
}

build() {
    cd FFmpeg-${pkgver}

    ./configure \
        --prefix=$VITASDK/arm-vita-eabi \
        --enable-vita \
        --target-os=vita \
        --enable-cross-compile \
        --cross-prefix=$VITASDK/bin/arm-vita-eabi- \
        --disable-runtime-cpudetect \
        --disable-armv5te \
        --disable-shared \
        --enable-static \
        --disable-programs \
        --disable-doc \
        --disable-autodetect \
        --disable-iconv \
        --disable-lzma \
        --disable-sdl2 \
        --disable-xlib \
        --disable-avdevice \
        --enable-swscale \
        --enable-swresample \
        --enable-network \
        --enable-libass \
        --enable-mbedtls \
        --enable-version3 \
        --enable-pthreads \
        \
        --enable-protocol=file \
        --enable-protocol=http \
        --enable-protocol=https \
        --enable-protocol=tcp \
        --enable-protocol=hls \
        --enable-protocol=crypto \
        --enable-protocol=httpproxy \
        \
        --enable-demuxer=hls \
        --enable-demuxer=flac \
        --enable-demuxer=flv \
        --enable-demuxer=aac \
        --enable-demuxer=ac3 \
        --enable-demuxer=h264 \
        --enable-demuxer=hevc \
        --enable-demuxer=mp3 \
        --enable-demuxer=wav \
        --enable-demuxer=ogg \
        --enable-demuxer=mov \
        --enable-demuxer=mpegts \
        --enable-demuxer=mpegps \
        --enable-demuxer=mjpeg \
        --enable-demuxer=matroska \
        --enable-demuxer=ass \
        --enable-demuxer=srt \
        --enable-demuxer=dvbsub \
        \
        --enable-decoder=h264 \
        --enable-decoder=h264_vita \
        --enable-decoder=aac \
        --enable-decoder=aac_latm \
        --enable-decoder=ac3 \
        --enable-decoder=eac3 \
        --enable-decoder=bmp \
        --enable-decoder=flv \
        --enable-decoder=flac \
        --enable-decoder=mjpeg \
        --enable-decoder=mp3 \
        --enable-decoder=vorbis \
        --enable-decoder=opus \
        --enable-decoder=pcm_s16le \
        --enable-decoder=pcm_s24le \
        --enable-decoder=srt \
        --enable-decoder=subrip \
        --enable-decoder=ssa \
        --enable-decoder=ass \
        --enable-decoder=dvbsub \
        --enable-decoder=dvdsub \
        --enable-decoder=pgssub \
        --enable-decoder=webvtt \
        --enable-decoder=movtext \
        \
        --enable-parser=h264 \
        --enable-parser=hevc \
        --enable-parser=aac \
        --enable-parser=aac_latm \
        --enable-parser=ac3 \
        --enable-parser=flac \
        --enable-parser=mpegaudio \
        --enable-parser=vorbis \
        --enable-parser=opus \
        \
        --disable-encoders \
        --disable-muxers \
        --disable-bsfs \
        --disable-filters \
        --enable-bsf=h264_mp4toannexb \
        --enable-bsf=hevc_mp4toannexb \
        --enable-filter=scale \
        --enable-filter=aresample

    # IMPORTANT: Do NOT disable HAVE_GETADDRINFO
    # The original build had this line which broke HTTP:
    # sed 's/#define HAVE_GETADDRINFO 1/#define HAVE_GETADDRINFO 0/g' -i config.h
    # We're removing it to enable DNS resolution

    # However, if Vita's getaddrinfo doesn't work, we may need to use IP addresses
    # or implement a custom resolver. For now, let's try with it enabled.

    make -j$(nproc)
}

package() {
    cd FFmpeg-${pkgver}
    make DESTDIR=$pkgdir install
}
